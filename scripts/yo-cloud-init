#!/bin/bash
USER=`whoami`
SRC="/w"

sudo rm -rf /etc/yum.repos.d/docker-ce.repo
sudo dnf install rsync dwarves ccache cronie -y
sudo rm -rf $SRC

sudo mkdir -p $SRC
sudo chown -R $USER:mtl $SRC/

git clone /swgwork/$USER/src/rdma-core $SRC/rdma-core

git clone /swgwork/$USER/src/kernel $SRC/kernel
cp /.autodirect/l/upstream/common_new/kernels/latest-for-upstream-debug/CONFIGS/config.x86_64.debug $SRC/kernel/.config

TMPFILE=$(mktemp)
cat <<EOF > $TMPFILE
CONFIG_SUNRPC_XPRT_RDMA=n
CONFIG_RDS=n
CONFIG_RDS_RDMA=n
CONFIG_OPENVSWITCH=n
CONFIG_OPENVSWITCH_GRE=n
CONFIG_OPENVSWITCH_VXLAN=n
CONFIG_OPENVSWITCH_GENEVE=n
CONFIG_NET_NSH=n
CONFIG_NETDEVSIM=n
CONFIG_MPLS=n
CONFIG_MLXSW=n
CONFIG_MLXFW=n
CONFIG_MLX4_CORE=n
CONFIG_MLX4_EN=n
CONFIG_MLX4_INFINIBAND=n
CONFIG_MLX5_FPGA=n
CONFIG_NETFILTER=n
CONFIG_NF_CONNTRACK=n
CONFIG_BPFILTER=n
CONFIG_RDMA_RXE=n
CONFIG_INFINIBAND_SRP=n
CONFIG_INFINIBAND_ISER=n
CONFIG_CGROUP_SCHED=n
CONFIG_CGROUP_PID=n
CONFIG_CGROUP_RDMA=n
CONFIG_CGROUP_FREEZER=n
CONFIG_CGROUP_DEVICE=n
CONFIG_CGROUP_CPUACCT=n
CONFIG_MEMCG=n
CONFIG_CGROUP_SCHED=n
CONFIG_KEXEC=n
CONFIG_KEXEC_FILE=n
CONFIG_KVM_AMD=n
CONFIG_SECURITY=n
EOF
$SRC/kernel/scripts/kconfig/merge_config.sh -y -m -Q $SRC/kernel/.config $TMPFILE

mkdir /w/ccache
#cp -r /swgwork/$USER/ccache /w
sudo systemctl enable crond
sudo systemctl start crond

#TMPFILE=$(mktemp)
#echo '#!/usr/bin/sh' > $TMPFILE
#echo "sudo -u "$USER" cp -a /w/ccache/? /swgwork/"$USER"/ccache" >> $TMPFILE
#echo "sudo -u "$USER" cp -a /swgwork/"$USER"/ccache/? /w/ccache" >> $TMPFILE
#sudo -u leonro cp -a /swgwork/leonro/ccache/? /w/ccache

#sudo cp $TMPFILE /etc/cron.daily/ccache-sync
#sudo chmod a+x /etc/cron.daily/ccache-sync
#rm -rf $TMPFILE

# We don't need docker inside testing VM
sudo systemctl stop docker.socket
sudo systemctl disable docker.socket
sudo systemctl stop docker
sudo systemctl disable docker

echo 'vm.nr_hugepages = 2' > $TMPFILE
sudo cp $TMPFILE /etc/sysctl.d/60-yo.conf
sudo chmod a+r /etc/sysctl.d/60-yo.conf

grep -v 'systemd-ask-password-plymouth' /usr/lib/dracut/modules.d/00systemd/module-setup.sh > $TMPFILE
sudo cp $TMPFILE /usr/lib/dracut/modules.d/00systemd/module-setup.sh
cat <<EOF > $TMPFILE
omit_dracutmodules+="plymouth pollcdrom resume"
EOF
sudo cp $TMPFILE /etc/dracut.conf.d/yo.conf
rm -rf $TMPFILE
